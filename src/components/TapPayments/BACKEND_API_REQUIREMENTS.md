# Tap Payments Backend Integration Requirements

This document outlines the API endpoints and data structures required for Tap Payments integration.

## Overview

The frontend uses Tap Payments (Benefit Pay) SDK to process payments. The backend needs to:
1. **Initialize payments** - Generate Tap payment configuration (public key, merchant ID, hash string)
2. **Verify payments** - Verify payment completion and update order status
3. **Handle webhooks** - Receive payment status updates from Tap
4. **Provide payment status** - Allow frontend to check payment status

---

## Required API Endpoints

### 1. Initiate Payment

**Endpoint:** `POST /events/:eventId/payments/initiate`

**Purpose:** Initialize a payment session and get Tap payment configuration

**Request Body:**
```json
{
  "payment": {
    "amount": "12.50",
    "currency": "BHD",
    "orderId": "ord_123456",           // Optional: Your internal order ID
    "transactionId": "txn_123456",     // Optional: Your internal transaction ID
    "customer": {                       // Optional
      "firstName": "John",
      "lastName": "Doe",
      "email": "john@example.com",
      "phone": {
        "countryCode": "+20",
        "number": "1000000000"
      }
    },
    "metadata": {                       // Optional: Custom data
      "udf1": "event_registration",
      "udf2": "user_123",
      "udf3": "ticket_type_vip"
    }
  }
}
```

**Response:**
```json
{
  "data": {
    "publicKey": "pk_test_xxxxx",      // Tap public key (from Tap dashboard)
    "merchantId": "merchant_xxxxx",    // Tap merchant ID (from Tap dashboard)
    "hashString": "generated_hash_here", // Hash string for payment security (generated by backend)
    "transactionId": "txn_123456",     // Transaction ID (generated if not provided)
    "orderId": "ord_123456"            // Order ID (generated if not provided)
  }
}
```

**Backend Responsibilities:**
- Generate unique `transactionId` and `orderId` if not provided
- Generate `hashString` using Tap's hash algorithm (see Tap documentation)
- Store payment intent in database (status: "pending")
- Return Tap configuration needed for frontend SDK

---

### 2. Verify Payment

**Endpoint:** `POST /events/:eventId/payments/verify`

**Purpose:** Verify payment completion after Tap SDK calls `onSuccess`

**Request Body:**
```json
{
  "payment_verification": {
    "transactionId": "txn_123456",           // Your internal transaction ID
    "tapTransactionId": "tap_txn_xxxxx",     // Tap's transaction ID from onSuccess callback
    "paymentData": {                         // Full response from Tap SDK onSuccess callback
      "id": "tap_txn_xxxxx",
      "status": "CAPTURED",
      "amount": "12.50",
      "currency": "BHD",
      // ... other Tap response fields
    }
  }
}
```

**Response:**
```json
{
  "data": {
    "success": true,
    "message": "Payment verified successfully",
    "orderId": "ord_123456",
    "transactionId": "txn_123456",
    "status": "completed",
    "amount": "12.50",
    "currency": "BHD"
  }
}
```

**Backend Responsibilities:**
- Verify payment with Tap API (server-side verification)
- Update payment record in database (status: "completed")
- Update order/registration status
- Send confirmation email if needed
- Return verification result

---

### 3. Get Payment Status

**Endpoint:** `GET /events/:eventId/payments/:transactionId/status`

**Purpose:** Check payment status (for polling or status checks)

**Response:**
```json
{
  "data": {
    "status": "completed",              // "completed" | "pending" | "failed" | "cancelled"
    "transactionId": "txn_123456",
    "orderId": "ord_123456",
    "amount": "12.50",
    "currency": "BHD",
    "createdAt": "2026-01-29T10:00:00Z",
    "updatedAt": "2026-01-29T10:05:00Z"
  }
}
```

---

### 4. Get Payment History

**Endpoint:** `GET /events/:eventId/payments`

**Query Parameters:**
- `page` (optional): Page number (default: 1)
- `per_page` (optional): Items per page (default: 20)
- `status` (optional): Filter by status ("completed" | "pending" | "failed" | "cancelled")

**Response:**
```json
{
  "data": {
    "payments": [
      {
        "transactionId": "txn_123456",
        "orderId": "ord_123456",
        "amount": "12.50",
        "currency": "BHD",
        "status": "completed",
        "customer": {
          "firstName": "John",
          "lastName": "Doe",
          "email": "john@example.com"
        },
        "createdAt": "2026-01-29T10:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "per_page": 20,
      "total": 50,
      "total_pages": 3
    }
  }
}
```

---

### 5. Webhook Endpoint (Backend Only)

**Endpoint:** `POST /events/:eventId/payments/webhook` (or separate webhook URL)

**Purpose:** Receive payment status updates from Tap

**Note:** This is handled entirely by the backend. Tap will send webhook notifications for:
- Payment completion
- Payment failure
- Payment cancellation
- Refunds

**Webhook Payload (from Tap):**
```json
{
  "id": "tap_webhook_xxxxx",
  "object": "event",
  "type": "charge.succeeded",
  "data": {
    "object": {
      "id": "tap_txn_xxxxx",
      "status": "CAPTURED",
      "amount": "12.50",
      "currency": "BHD",
      // ... other Tap fields
    }
  }
}
```

**Backend Responsibilities:**
- Verify webhook signature from Tap
- Update payment status in database
- Handle payment completion/failure logic
- Send notifications if needed

---

## Database Schema Suggestions

### Payments Table
```sql
CREATE TABLE payments (
  id SERIAL PRIMARY KEY,
  event_id INTEGER NOT NULL,
  transaction_id VARCHAR(255) UNIQUE NOT NULL,
  order_id VARCHAR(255),
  tap_transaction_id VARCHAR(255),
  amount DECIMAL(10, 2) NOT NULL,
  currency VARCHAR(3) NOT NULL,
  status VARCHAR(50) NOT NULL, -- 'pending', 'completed', 'failed', 'cancelled'
  customer_data JSONB,
  metadata JSONB,
  tap_response JSONB,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

---

## Security Considerations

1. **Hash String Generation:**
   - Backend must generate `hashString` using Tap's hash algorithm
   - Never expose Tap secret keys to frontend
   - Use environment variables for Tap credentials

2. **Payment Verification:**
   - Always verify payments server-side (don't trust frontend callbacks alone)
   - Verify with Tap API after receiving `onSuccess` callback
   - Use webhooks as primary source of truth

3. **Transaction IDs:**
   - Generate unique transaction IDs server-side
   - Use UUIDs or timestamp-based IDs
   - Ensure transaction IDs are unique per event

---

## Integration Flow

1. **User clicks "Pay"** → Frontend calls `initiateTapPayment()`
2. **Backend generates payment config** → Returns `publicKey`, `merchantId`, `hashString`
3. **Frontend renders Tap button** → Uses config from backend
4. **User completes payment** → Tap SDK calls `onSuccess` callback
5. **Frontend calls `verifyTapPayment()`** → Sends payment data to backend
6. **Backend verifies with Tap API** → Updates database and order status
7. **Backend receives webhook** → Confirms payment (webhook is source of truth)

---

## Testing

### Test Mode
- Use Tap test credentials (`pk_test_xxxxx`)
- Set `debug: true` in frontend component
- Use test card numbers from Tap documentation

### Production Mode
- Use Tap production credentials (`pk_live_xxxxx`)
- Set `debug: false` in frontend component
- Ensure webhook URL is configured in Tap dashboard

---

## Next Steps for Backend Developer

1. ✅ Set up Tap merchant account and get credentials
2. ✅ Implement `POST /events/:eventId/payments/initiate` endpoint
3. ✅ Implement hash string generation (see Tap documentation)
4. ✅ Create payments table in database
5. ✅ Implement `POST /events/:eventId/payments/verify` endpoint
6. ✅ Set up webhook endpoint and configure in Tap dashboard
7. ✅ Implement `GET /events/:eventId/payments/:transactionId/status` endpoint
8. ✅ Implement `GET /events/:eventId/payments` endpoint (optional, for admin)
9. ✅ Test with Tap test credentials
10. ✅ Deploy and configure production credentials

---

## Frontend Implementation Status

✅ TapPayment component created with proper props
✅ API helper functions created (ready to use once backend is ready)
⏳ Waiting for backend endpoints to be implemented
⏳ Component will be integrated into registration/checkout flow once backend is ready

---

## Questions for Backend Developer

1. What will be the exact endpoint URLs? (currently using `/events/:eventId/payments/...`)
2. What Tap credentials should be used? (test vs production)
3. How should payment amounts be stored? (as string or decimal?)
4. What metadata fields are needed? (udf1-udf5)
5. Should payment be linked to event registration/user? (via event_user_id?)
